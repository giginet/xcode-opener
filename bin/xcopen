#!/usr/bin/env bash

version() {
    echo "xcode-opener 0.2.0 by giginet <giginet.net@gmail.com>"
    echo "https://github.com/giginet/xcode-opener"
}

usage() {
  version
cat << EOF >&2
Xcode Opener
Open Xcode project by context

Usage:
    $(basename $0) [command] [<args>]
Commands:
    open                  Open Xcode projects by context
    help                  Display usage
    version               Display current script version
EOF
}

_find() {
  echo $(find . -maxdepth 1 -name "$1" -print -quit) | tail -n 1
}

open_xcode() {
  XCODE_PATH=$(mdfind "kMDItemCFBundleIdentifier == 'com.apple.dt.Xcode'" | head -n1)
  XCODE_PATH=${XCODE_PATH:-"/Applications/Xcode.app"} 

  if [ -e "Package.swift" ]; then
    open -a $XCODE_PATH ./
    exit 0
  elif [ -n "$(_find "*.xcworkspace")" ]; then
    open -a $XCODE_PATH *.xcworkspace
    exit 0
  elif [ -n "$(_find "*.xcodeproj")" ]; then
    open -a $XCODE_PATH *.xcodeproj
    exit 0
  else
    echo "Could not found any Xcode project"
    echo "The current directory must contain Package.swift, *.xcworkspace or *.xcodeproj"
    exit 1
  fi
}

subcommand=$1
subcommand=${subcommand:-"open"}

case $subcommand in
  "open" )
    open_xcode
    exit 0
    ;;
  "help" )
    usage
    exit 0
    ;;
  "version" )
    version
    exit 0
    ;;
  * )
    echo "Unknown command $subcommand"
esac
